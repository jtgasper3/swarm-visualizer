<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Docker Swarm Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://fonts.bunny.net/css?family=roboto:400,500,700" rel="stylesheet" />

  <style>
    .server-card {
      flex: 1 1 240px;
    }
    #server.v-table>.v-table__wrapper>table>tbody>tr>td, #server.v-table>.v-table__wrapper>table>tbody>tr>th, #server.v-table>.v-table__wrapper>table>tfoot>tr>td, #server.v-table>.v-table__wrapper>table>tfoot>tr>th, #server.v-table>.v-table__wrapper>table>thead>tr>td, #server.v-table>.v-table__wrapper>table>thead>tr>th {
      padding: 0 4px;
    }
    #server.v-table>.v-table__wrapper>table>tbody>tr>th, #server.v-table>.v-table__wrapper>table>tfoot>tr>th, #server.v-table>.v-table__wrapper>table>thead>tr>th {
      height: min-content;
    }
  </style>
  
  <script type="importmap">
    {
      "imports": {
        "vue": "https://cdn.jsdelivr.net/npm/vue@3/dist/vue.esm-browser.js",
        "vuetify": "https://cdn.jsdelivr.net/npm/vuetify@3/dist/vuetify.esm.js",
        "@vueuse/shared": "https://cdn.jsdelivr.net/npm/@vueuse/shared@12/index.min.mjs",
        "@vueuse/core": "https://cdn.jsdelivr.net/npm/@vueuse/core@12/index.min.mjs"
      }
    }
  </script>
</head>

<body>
  <div id="app">
    <v-app>
      <v-app-bar class="ps-4" flat>
        <v-app-bar-nav-icon v-if="$vuetify.display.lgAndDown" @click="drawer = !drawer" title="Toggle sorting and filtering pane"></v-app-bar-nav-icon>

        <v-app-bar-title>
          <WebSocket @update="updateReceivedData" @not-authorized="getAuthorized()">
            <template #icon="{ state }">
              <v-badge :color="state === 'connected' ? 'success' : 'error'" dot inline floating :title="state" :aria-label="'Connection: ' + state"></v-badge>
            </template>
          </WebSocket>
          {{ clusterName }}
        </v-app-bar-title>

        <template #append>
            <div class="ga-2 align-center">
              <!-- <v-btn color="medium-emphasis" icon="mdi-email-outline">
                <v-badge color="error" content="1" dot>
                  <v-icon />
                </v-badge>
              </v-btn>

              <v-divider class="align-self-center" length="24" vertical></v-divider>
 
              <v-btn class="me-2" height="48" icon>
                <v-avatar color="surface-light" image="https://cdn.vuetifyjs.com/images/john.png" size="32" />

                <v-menu activator="parent">
                  <v-list density="compact" nav>
                    <v-list-item append-icon="mdi-cog-outline" link title="Settings"></v-list-item>

                    <v-list-item append-icon="mdi-logout" link title="Logout"></v-list-item>
                  </v-list>
                </v-menu>
              </v-btn>
              -->
            </div>
          </template>
      </v-app-bar>

      <v-navigation-drawer v-model="drawer" color="surface-light" width="280" aria-label="Filter and Sorting">
        <div class="px-2">
          <v-list v-model:selected="filters.nodesSelection" density="comfortable" nav slim select-strategy="leaf" aria-labelledby="filtering">
            <span id="filtering" class="font-weight-bold">FILTER</span>
            
            <v-list-subheader class="font-weight-bold">NODES
              (<v-btn size="x-small" slim color="primary" variant="text" @click="selectNodes('all')">all</v-btn>/<v-btn size="x-small" slim color="primary" variant="text"
                @click="selectNodes('none')">none</v-btn>)</v-list-subheader>
            <v-list-item v-for="node in sortedNodes" :key="node.ID" :title="node.Description.Hostname" :value="node.ID" density="compact">
              <template v-slot:prepend="{ isSelected, select }">
                <v-list-item-action start>
                  <v-checkbox-btn :model-value="isSelected" @update:model-value="select" density="compact" color="primary" hide-details></v-checkbox-btn>
                </v-list-item-action>
              </template>
            </v-list-item>
          </v-list>

          <v-list density="comfortable" nav slim aria-labelledby="roles">
            <v-list-subheader id="roles" class="font-weight-bold">ROLE</v-list-subheader>
            <v-btn-toggle
              v-model="filters.nodeRoles"
              color="primary"
              divided
              rounded="pill"
              density="compact"
            >
              <v-btn size="x-small" value="manager">Managers</v-btn>
              <v-btn size="x-small" :value="false">Both</v-btn>
              <v-btn size="x-small" value="worker">Workers</v-btn>
            </v-btn-toggle>
          </v-list>

          <v-list v-model:selected="filters.servicesSelection" density="comfortable" nav slim select-strategy="leaf" aria-labelledby="services">
            <v-list-subheader class="font-weight-bold"><span id="services">SERVICES</span>
              (<v-btn size="x-small" slim color="primary" variant="text" @click="selectServices('all')">all</v-btn>/<v-btn size="x-small" color="primary" variant="text" slim 
                @click="selectServices('none')">none</v-btn>)</v-list-subheader>
            <v-list-item v-for="service in sortedServices" :key="service.ID" :title="createServiceName(service)" :value="service.ID" density="compact">
              <template v-slot:prepend="{ isSelected, select }">
                <v-list-item-action start>
                  <v-checkbox-btn :model-value="isSelected" @update:model-value="select" density="compact" hide-details color="primary"></v-checkbox-btn>
                </v-list-item-action>
              </template>
            </v-list-item>
          </v-list>

          <v-list density="comfortable" nav slim aria-labelledby="modes">
            <v-list-subheader id="modes" class="font-weight-bold">MODE</v-list-subheader>
              <v-btn-toggle
                v-model="filters.serviceMode"
                color="primary"
                divided
                rounded="pill"
                density="compact"
              >
                <v-btn size="x-small" value="replicated">Replicated</v-btn>
                <v-btn size="x-small" :value="false">Both</v-btn>
                <v-btn size="x-small" value="global">Global</v-btn>
              </v-btn-group>
            </v-btn-toggle>
          </v-list>

          <!-- <v-list v-if="filters.replicasIncluded" density="comfortable" nav slim>
              <v-list-subheader class="font-weight-bold">REPLICAS</v-list-subheader>
              <v-list-item>
                <v-range-slider v-model="filters.replicas" :max="5" :min="0" :step="1" thumb-label density="compact"></v-slider>
              </v-list-item>
            </v-list> -->

          <v-list v-model:selected="filters.networksSelection" density="compact" nav slim select-strategy="leaf" aria-labelledby="networks">
            <v-list-subheader class="font-weight-bold"><span id="networks">NETWORKS</span>
              (<v-btn size="x-small" slim color="primary" variant="text" @click="selectNetworks('all')">all</v-btn>/<v-btn size="x-small" color="primary" variant="text" slim 
                @click="selectNetworks('none')">none</v-btn>)</v-list-subheader>
            <v-list-item v-for="network in sortedNetworks" :key="network.Id" :title="network.Name" :value="network.Id" density="compact">
              <template v-slot:prepend="{ isSelected, select }">
                <v-list-item-action start>
                  <v-checkbox-btn :model-value="isSelected" @update:model-value="select" density="compact" hide-details color="primary"></v-checkbox-btn>
                </v-list-item-action>
              </template>
            </v-list-item>
            <v-list-item title="(none)" value="(none)" density="compact">
              <template v-slot:prepend="{ isSelected, select }">
                <v-list-item-action start>
                  <v-checkbox-btn :model-value="isSelected" @update:model-value="select" density="compact" hide-details color="primary"></v-checkbox-btn>
                </v-list-item-action>
              </template>
            </v-list-item>
          </v-list>

          <v-list density="comfortable" nav slim aria-labelledby="search">
            <v-list-item>
              <v-text-field v-model="filters.filterText" color="primary" bg-color="surface" density="compact" id="search"
                hide-details clearable persistent-clear placeholder="Search" prepend-inner-icon="mdi-magnify" rounded="lg" variant="outlined">
                <v-divider class="me-2 align-self-center" length="20" vertical />

                <template #clear="{ props: clearProps }">
                  <v-icon v-bind="clearProps" size="18" />
                </template>
              </v-text-field>
            </v-list-item>
          </v-list>
          
          <v-list density="comfortable" nav slim aria-labelledby="sorting">
            <span id="sorting" class="font-weight-bold">SORT</span>

            <v-list-item>
              <v-select density="compact" flat hide-details color="primary" bg-color="surface"  :items="['Service Name', 'Created']" label="Country"
                :list-props="{ density: 'compact', rounded: 't-0' }" v-model="sort" single-line variant="solo" />
            </v-list-item>
          </v-list>
        </div>

        <template #append>
          <v-divider />
        </template>
      </v-navigation-drawer>
      <v-main aria-label="Nodes and Services List">
        <v-container fluid>
          <v-list aria-label="Swarm Nodes" class="pa-0">
            <v-row class="d-flex flex-wrap ga-4">
              <v-col v-for="node in filteredNodes"
                :key="node.ID"
                class="server-card pa-1"
                style="max-width: 19rem"
                cols="auto"
              >
                <v-list-item :aria-label="node.Description.Hostname" class="pa-0">
                  <Node :node="node" :filters="filters" :sort="sort" />
                </v-list-item>
              </v-col>
            </v-row>
          </v-list>
        </v-container>
      </v-main>
    </v-app>
  </div>

  <script type="module">
    import { computed, createApp, ref } from 'vue';
    import { createVuetify } from 'vuetify';
    import { useStorage } from '@vueuse/core';

    import Node from './node.js';
    import Websocket from './websocket.js';

    const vuetify = createVuetify({
      theme: {
        defaultTheme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
      }
    });

    createApp({
      setup() {
        const clusterName = ref('Loading...');
        const drawer = ref(true);
        const filters = useStorage('filters.3', {
          filterText: '',
          networksSelection: new Array(),
          nodesSelection: new Array(),
          servicesSelection: new Array(),
          nodeRoles: false,
          serviceMode: false,
          // replicas: [0, 10]
        },
        undefined,
        {
          serializer: {
            read: (v) => v ? JSON.parse(v) : null,
            write: (v) => JSON.stringify(v),
          },
        });

        const sort = useStorage('sort', 'Service Name');
        const nodes = ref([]);
        const networks = ref([]);
        const services = ref([]);

        const sortedNetworks = computed(() => networks.value.sort((a, b) => a.Name.localeCompare(b.Name)));
        const sortedNodes = computed(() => nodes.value.sort((a, b) => a.Description.Hostname.localeCompare(b.Description.Hostname)));
        const sortedServices = computed(() => services.value.sort((a, b) => a.Spec.Name.localeCompare(b.Spec.Name)));
        const filteredNodes = computed(() => sortedNodes.value
          .filter(node => {
            if (!filters.value.nodeRoles) {
              return true;
            }
            return node.Spec.Role === filters.value.nodeRoles;
          })
          .filter(node => {
            if (filters.node === 'all') {
              return true;
            }
            return filters.value.nodesSelection.includes(node.ID);
          })
        );

        function createServiceName(service) {
          if (service.Spec.Mode.Replicated !== undefined  && service.Spec.Mode.Replicated.Replicas !== undefined && service.Spec.Mode.Replicated.Replicas > 1) {
            return `${service.Spec.Name} (${service.Spec.Mode.Replicated.Replicas} replicas)`;
          }
          return service.Spec.Name;
        } 

        function getAuthorized() {
          window.location.href = window.location.pathname + 'login';
        }

        function selectNetworks(option) {
          if (option === 'all') {
            const uniqueItems = networks.value.filter(network => !filters.value.networksSelection.includes(network.Id)).map((network => network.Id))
            filters.value.networksSelection.push(...uniqueItems)
            filters.value.networksSelection.push('(none)')
          } else {
            filters.value.networksSelection.length = 0
          }
        }

        function selectNodes(option) {
          if (option === 'all') {
            const uniqueItems = nodes.value.filter(node => !filters.value.nodesSelection.includes(node.ID)).map((node => node.ID))
            filters.value.nodesSelection.push(...uniqueItems)
          } else {
            filters.value.nodesSelection.length = 0
          }
        }
        
        function selectServices(option) {
          if (option === 'all') {
            const uniqueItems = services.value.filter(service => !filters.value.servicesSelection.includes(service.ID)).map((service => service.ID))
            filters.value.servicesSelection.push(...uniqueItems)
          } else {
            filters.value.servicesSelection.length = 0
          }
        }

        function updateReceivedData(data) {
          clusterName.value = data.clusterName;

          networks.value = data.networks;

          services.value = data.services.map((service) => {
            service.index = data.services.findIndex((serv) => serv.ID === service.ID);
            if (service.Spec.TaskTemplate.Networks) {
              service.networks = service.Spec.TaskTemplate.Networks.map((network) => data.networks.find((n) => n.Id === network.Target));
            }
            return service;
          })

          nodes.value = data.nodes.map((node) => {
            if (data.tasks) {
              node.tasks = data.tasks
                .filter(task => task.NodeID === node.ID)
                .map((task) => {
                  task.service = services.value.find((service) => task.ServiceID === service.ID);
                  return task;
                });
            }

            return node;
          });
        }

        function onSystemThemeChange(event) {
          $vuetify.theme.global.name = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }


        return {
          clusterName,
          drawer,
          filters,
          sort,
          networks,
          sortedNetworks,
          nodes,
          filteredNodes,
          sortedNodes,
          services,
          sortedServices,
          createServiceName,
          getAuthorized,
          selectNetworks,
          selectNodes,
          selectServices,
          updateReceivedData,
          onSystemThemeChange,
        };
      },

      components: {
        Node,
        Websocket,
      },

      mounted() {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', this.onSystemThemeChange);
      },
      beforeDestroy() {
        window.matchMedia('(prefers-color-scheme: dark)').removeEventListener('change', this.onSystemThemeChange);
      }
    }).use(vuetify).mount('#app');
  </script>
</body>

</html>