<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Docker Swarm Monitor</title>
  <!-- Add Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3"></script>
  <!-- Add Vuetify 3 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.7.11/dist/vuetify.min.js"></script>
  <!-- Add Vuetify CSS -->
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.7.11/dist/vuetify.min.css" rel="stylesheet">
  <!-- Add Material Design Icons -->
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
  <!-- Load the Nodes component JavaScript -->
  <script src="nodes.js" type="module"></script>
</head>

<body>
  <div id="app">
    <v-app>
      <v-main>
        <v-container class="pa-md-12" fluid>
          <h2 v-if="clusterName" class="text-h4 font-weight-bold mb-4">{{ clusterName }}</h2>
          <v-row>
            <v-col v-for="(node, i) in nodes" :key="i" class="d-flex" cols="12" lg="3" sm="6">
              <v-card border color="grey-lighten-4" flat rounded="lg">
                <v-card-title>
                  <v-badge :color="nodeStatus(node.status)" dot inline floating></v-badge>{{ node.hostname }}: {{
                  node.status }}
                </v-card-title>
                <v-card-text>
                  <v-chip color="primary" class="ma-1 pa-1" label size="x-medium">{{ node.role }}</v-chip>
                  <v-chip color="primary" class="ma-1 pa-1" label size="x-medium">{{ node.platformArchitecture
                    }}</v-chip>
                </v-card-text>
                <v-card-text class="mt-n4">
                  <v-card v-for="(task, j) in node.tasks" :key="j" border class="d-flex flex-column mb-2" flat
                    rounded="lg">
                    <v-card-title>
                      <v-badge :color="taskStatus(task.state)" dot inline floating></v-badge>
                      {{ task.service.name }}
                    </v-card-title>
                    <v-card-text>
                      <v-chip color="primary" class="ma-1 pa-1" label size="x-medium">{{ task.service.mode }}</v-chip>
                      <v-spacer />
                      <span class="flex-1-1-100">
                        Image: {{ task.service.image.split('@')[0] }}
                      </span>
                      <v-spacer />
                      <span class="text-small-emphasis">
                        Created: {{ date.format(task.createdAt, 'keyboardDateTime12h') }}
                      </span>
                    </v-card-text>
                    <!-- <v-card-actions>
                      <v-spacer />
          
                      <v-btn class="text-none" color="primary" text="Get Started" />
                    </v-card-actions> -->
                  </v-card>
                </v-card-text>
              </v-card>
            </v-col>
          </v-row>
        </v-container>
      </v-main>
    </v-app>
  </div>

  <script type="module">
    import Nodes from './nodes.js';

    const { createApp } = Vue;
    const { createVuetify, useDate } = Vuetify;

    const vuetify = createVuetify();

    createApp({
      data() {
        return {
          clusterName: "Loading...",
          date: useDate(),
          services: [],
          nodes: []
        };
      },
      computed: {

      },
      mounted() {
        this.connectWebSocket();
      },
      methods: {
        connectWebSocket() {
          const ws = new WebSocket('ws://' + window.location.host + '/ws');

          ws.onopen = () => {
            console.log('WebSocket connection established');
          };

          ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.clusterName = data.clusterName;
            this.services = data.services;
            this.nodes = data.nodes.map((node) => {
              node.tasks = data.tasks
                .filter(task => task.nodeID === node.ID)
                .map((task) => {
                  task.service = this.services.find((service) => task.serviceId === service.id);
                  return task;
                });

              return node;
            });
            console.log(this.services)
            console.log(this.nodes)
          };

          ws.onclose = () => {
            console.log('WebSocket connection closed');
          };

          ws.onerror = (error) => {
            console.error('WebSocket error:', error);
          };
        },
        nodeStatus(status) {
          switch (status) {
            case 'ready': return 'success'; break
            default: return 'error'; break
          }
        },
        taskStatus(status) {
          switch (status) {
            case 'running': return 'success'; break
            default: return 'error'; break
          }
        },
      }
    }).use(vuetify).mount('#app');
  </script>
</body>

</html>